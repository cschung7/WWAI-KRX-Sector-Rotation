<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Theme Network Graph - KRX Sector Rotation</title>
    <!-- Version: 2026.02.15.v1 - KOR/ENG language toggle -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 1rem 2rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
        }

        .nav-links a {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .nav-links a:hover, .nav-links a.active {
            background: #334155;
            color: #f8fafc;
        }

        .nav-links a.home-btn {
            background: #3b82f6;
            color: #fff;
            font-weight: 500;
        }

        .nav-links a.home-btn:hover {
            background: #2563eb;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        .sidebar {
            width: 320px;
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 1rem;
            overflow-y: auto;
        }

        .search-box {
            margin-bottom: 1rem;
            position: relative;
        }

        .search-box label {
            display: block;
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .search-input {
            display: flex;
            gap: 0.5rem;
        }

        .search-input input {
            flex: 1;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.375rem;
            padding: 0.5rem;
            color: #f8fafc;
            font-size: 0.875rem;
        }

        .search-input input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .search-input button {
            background: #3b82f6;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .search-input button:hover {
            background: #2563eb;
        }

        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .tab {
            flex: 1;
            padding: 0.5rem;
            background: #334155;
            border: none;
            border-radius: 0.375rem;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .tab.active {
            background: #3b82f6;
            color: white;
        }

        .info-panel {
            background: #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-panel h3 {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            color: #f8fafc;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0;
            border-bottom: 1px solid #475569;
            font-size: 0.8125rem;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #94a3b8;
        }

        .info-value {
            font-weight: 600;
        }

        .info-value.bullish { color: #10b981; }
        .info-value.neutral { color: #3b82f6; }
        .info-value.bearish { color: #ef4444; }
        .info-value.very-strong { color: #10b981; }
        .info-value.strong { color: #3b82f6; }
        .info-value.moderate { color: #f59e0b; }
        .info-value.weak { color: #ef4444; }

        .stock-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.625rem 0.75rem;
            background: #475569;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .stock-item:hover {
            background: #64748b;
        }

        .stock-item.buy, .stock-item.strong_buy {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }

        .stock-item.avoid {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .stock-item.hold, .stock-item.neutral {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .stock-info {
            flex: 1;
        }

        .stock-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .stock-ticker {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .stock-signal {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .signal-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-badge.buy, .signal-badge.strong_buy {
            background: #10b981;
            color: white;
        }

        .signal-badge.avoid {
            background: #ef4444;
            color: white;
        }

        .signal-badge.hold, .signal-badge.neutral {
            background: #f59e0b;
            color: black;
        }

        .score-text {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.125rem;
        }

        .theme-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #475569;
        }

        .theme-header h4 {
            font-size: 1rem;
            color: #f8fafc;
        }

        .theme-stats {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .expand-hint {
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
            padding: 0.5rem;
            font-style: italic;
        }

        .theme-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .theme-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #475569;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8125rem;
        }

        .theme-item:hover {
            background: #64748b;
        }

        .theme-item.expanded {
            background: #3b82f6;
            border-left: 3px solid #60a5fa;
        }

        .theme-name {
            flex: 1;
        }

        .theme-fiedler {
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .theme-fiedler.very_strong { background: #10b981; color: white; }
        .theme-fiedler.strong { background: #3b82f6; color: white; }
        .theme-fiedler.moderate { background: #f59e0b; color: black; }
        .theme-fiedler.weak { background: #ef4444; color: white; }

        .graph-container {
            flex: 1;
            position: relative;
        }

        #network {
            width: 100%;
            height: 100%;
            background: #0f172a;
        }

        .graph-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .control-btn {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            color: #f8fafc;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .control-btn:hover {
            background: #475569;
        }

        .control-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .stats-bar {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            display: flex;
            gap: 1.5rem;
            font-size: 0.75rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #3b82f6;
        }

        .stat-label {
            color: #94a3b8;
        }

        .legend {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-text {
            color: #94a3b8;
            font-size: 1rem;
        }

        .hidden {
            display: none;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 0.25rem;
        }

        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:hover, .suggestion-item.selected {
            background: #334155;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-size: 0.875rem;
        }

        .suggestion-type {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            background: #475569;
        }

        .suggestion-type.stock {
            background: #3b82f6;
        }

        .suggestion-type.theme {
            background: #8b5cf6;
        }

        .suggestion-fiedler {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .suggestion-buy-pct {
            font-size: 0.7rem;
            font-weight: 600;
        }

        .suggestion-buy-pct.high { color: #10b981; }
        .suggestion-buy-pct.medium { color: #f59e0b; }
        .suggestion-buy-pct.low { color: #ef4444; }

        .market-flag {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Language Toggle */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-content {
            flex: 1;
        }

        .lang-toggle {
            display: flex;
            gap: 0.25rem;
            background: #334155;
            padding: 0.25rem;
            border-radius: 0.5rem;
        }

        .lang-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }

        .lang-btn:hover {
            color: #f8fafc;
        }

        .lang-btn.active {
            background: #3b82f6;
            color: white;
        }

        /* Quick Example Buttons */
        .quick-examples {
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #334155;
        }

        .quick-examples-label {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-bottom: 0.375rem;
        }

        .example-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            background: #334155;
            border: 1px solid #475569;
            color: #e2e8f0;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-btn:hover {
            background: #475569;
            border-color: #64748b;
        }

        .example-btn.theme {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
        }

        .example-btn.theme:hover {
            background: rgba(139, 92, 246, 0.3);
        }

        .error-toast {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            border: 1px solid #ef4444;
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            color: #f8fafc;
            font-size: 0.875rem;
            z-index: 10000;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            animation: toastIn 0.3s ease;
        }

        .error-toast .toast-title {
            color: #ef4444;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .error-toast .toast-suggestions {
            color: #94a3b8;
            margin-top: 0.5rem;
            font-size: 0.8125rem;
        }

        .error-toast .toast-close {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1.1rem;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-1rem); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="header-content">
                <h1 data-i18n="title"><span class="market-flag">&#127472;&#127479;</span>Theme Network Graph</h1>
                <p data-i18n="subtitle">Explore stock-theme relationships with Co-movement gravity</p>
            </div>
            <div class="lang-toggle">
                <button class="lang-btn active" onclick="setLanguage('ko')">KOR</button>
                <button class="lang-btn" onclick="setLanguage('en')">ENG</button>
            </div>
        </div>
        <nav class="nav-links">
            <a href="https://landing-three-ecru.vercel.app" class="home-btn">&#127968; Home</a>
            <a href="index.html" data-i18n="nav.overview">Overview</a>
            <a href="breakout.html" data-i18n="nav.momentum">Momentum</a>
            <a href="signals.html" data-i18n="nav.signals">Signals</a>
            <a href="cohesion.html" data-i18n="nav.cohesion">Cohesion</a>
            <a href="network.html" class="active" data-i18n="nav.network">Network</a>
            <a href="chat.html" data-i18n="nav.chat">&#128172; AI Chat</a>
        </nav>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <!-- Search -->
            <div class="search-box">
                <label data-i18n="search.label">Search Stock or Theme <span style="color: #64748b;">(partial match)</span></label>
                <div class="tabs">
                    <button class="tab active" onclick="setSearchMode('stock')" data-i18n="search.stock">Stock</button>
                    <button class="tab" onclick="setSearchMode('theme')" data-i18n="search.theme">Theme</button>
                </div>
                <div class="search-input" style="position: relative;">
                    <input type="text" id="searchInput" data-i18n-placeholder="search.placeholder"
                           placeholder="e.g., Samsung, 반도체, AI"
                           oninput="onSearchInput()" onkeydown="onSearchKeydown(event)">
                    <button onclick="doSearch()" data-i18n="search.button">Search</button>
                </div>
                <div id="searchSuggestions" class="search-suggestions hidden"></div>
                <div id="searchHint" style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;" data-i18n="search.hint">
                    Type 2+ chars for suggestions (266 themes, 2000+ stocks)
                </div>

                <!-- Quick Examples -->
                <div class="quick-examples">
                    <div class="quick-examples-label" data-i18n="examples.stocks">Popular Stocks:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.5rem;">
                        <button class="example-btn" onclick="quickSearch('stock', '삼성전자')">삼성전자</button>
                        <button class="example-btn" onclick="quickSearch('stock', 'SK하이닉스')">SK하이닉스</button>
                        <button class="example-btn" onclick="quickSearch('stock', 'LG에너지솔루션')">LG에너지솔루션</button>
                        <button class="example-btn" onclick="quickSearch('stock', '현대자동차')">현대자동차</button>
                        <button class="example-btn" onclick="quickSearch('stock', 'NAVER')">NAVER</button>
                        <button class="example-btn" onclick="quickSearch('stock', '카카오')">카카오</button>
                    </div>
                    <div class="quick-examples-label" data-i18n="examples.themes">Popular Themes:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                        <button class="example-btn theme" onclick="quickSearch('theme', '2차전지')">2차전지</button>
                        <button class="example-btn theme" onclick="quickSearch('theme', '반도체 장비')">반도체</button>
                        <button class="example-btn theme" onclick="quickSearch('theme', '지능형로봇/인공지능(AI)')">AI/인공지능</button>
                        <button class="example-btn theme" onclick="quickSearch('theme', '방위산업/전쟁 및 테러')">방위산업</button>
                        <button class="example-btn theme" onclick="quickSearch('theme', '로봇(산업용/협동로봇 등)')">로봇</button>
                    </div>
                </div>
            </div>

            <!-- Selected Node Info -->
            <div class="info-panel" id="nodeInfo">
                <h3 data-i18n="panel.selectedNode">Selected Node</h3>
                <div id="nodeDetails">
                    <p style="color: #64748b; font-size: 0.8125rem;" data-i18n="panel.clickNode">Click a node to see details</p>
                </div>
            </div>

            <!-- Connected Themes/Stocks -->
            <div class="info-panel">
                <h3 id="connectionTitle" data-i18n="panel.connectedThemes">Connected Themes</h3>
                <div class="theme-list" id="connectionList">
                    <p style="color: #64748b; font-size: 0.8125rem;" data-i18n="panel.searchToSee">Search for a stock to see themes</p>
                </div>
            </div>
        </div>

        <div class="graph-container">
            <div id="network"></div>

            <div class="loading-overlay hidden" id="loadingOverlay">
                <div class="loading-text" data-i18n="loading">Loading graph...</div>
            </div>

            <div class="graph-controls">
                <button class="control-btn active" id="physicsBtn" onclick="togglePhysics()" data-i18n="controls.physics">Physics: ON</button>
                <button class="control-btn" onclick="fitGraph()" data-i18n="controls.fit">Fit View</button>
                <button class="control-btn" onclick="resetGraph()" data-i18n="controls.reset">Reset</button>
            </div>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="statStocks">0</div>
                    <div class="stat-label" data-i18n="stats.stocks">Stocks</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statThemes">0</div>
                    <div class="stat-label" data-i18n="stats.themes">Themes</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statEdges">0</div>
                    <div class="stat-label" data-i18n="stats.connections">Connections</div>
                </div>
            </div>

            <div class="legend">
                <div class="legend-title" data-i18n="legend.comovement">Co-movement Gravity</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981"></div>
                    <span data-i18n="legend.veryStrong">Very Strong (>3.0)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6"></div>
                    <span data-i18n="legend.strong">Strong (1-3)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b"></div>
                    <span data-i18n="legend.moderate">Moderate (0.5-1)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444"></div>
                    <span data-i18n="legend.weak">Weak (<0.5)</span>
                </div>
                <div class="legend-title" style="margin-top: 0.75rem;" data-i18n="legend.stockSignal">Signal Score</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #059669; border-radius: 50%;"></div>
                    <span data-i18n="legend.strongBuy">Strong (&#8805;70)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981; border-radius: 50%;"></div>
                    <span data-i18n="legend.buy">Good (50-70)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b; border-radius: 50%;"></div>
                    <span data-i18n="legend.neutral">Neutral (30-50)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444; border-radius: 50%;"></div>
                    <span data-i18n="legend.avoid">Weak (&lt;30)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const STOCK_CHART_URL = 'https://wwai-stock-chart.vercel.app/stock';
        let network = null;
        let nodes = new vis.DataSet();
        let edges = new vis.DataSet();
        let searchMode = 'stock';
        let physicsEnabled = true;
        let expandedThemes = new Set();
        let currentLang = 'ko';
        let currentStockThemes = null;

        // Translations
        const translations = {
            ko: {
                title: '<span class="market-flag">&#127472;&#127479;</span>KRX &#49465;&#53552; &#47196;&#53580;&#51060;&#49496;',
                subtitle: '&#53580;&#47560;-&#51333;&#47785; &#45348;&#53944;&#50892;&#53356; &#44536;&#47000;&#54532;',
                'nav.overview': '&#44060;&#50836;',
                'nav.momentum': '&#47784;&#47704;&#53568;',
                'nav.signals': '&#49884;&#44536;&#45328;',
                'nav.cohesion': '&#44400;&#51665;&#49457;',
                'nav.network': '&#45348;&#53944;&#50892;&#53356;',
                'nav.chat': '&#128172; AI &#52292;&#54021;',
                'search.label': '&#51333;&#47785; &#46608;&#45716; &#53580;&#47560; &#44160;&#49353; <span style="color: #64748b;">(&#48512;&#48516; &#51068;&#52824;)</span>',
                'search.stock': '&#51333;&#47785;',
                'search.theme': '&#53580;&#47560;',
                'search.placeholder': '&#50696;: &#48152;&#46020;, 2&#52264;&#51204;, AI',
                'search.button': '&#44160;&#49353;',
                'search.hint': '2&#44544;&#51088; &#51060;&#49345; &#51077;&#47141;&#54616;&#47732; &#51088;&#46041;&#50756;&#49457; (266 &#53580;&#47560;)',
                'examples.stocks': '&#51452;&#50836; &#51333;&#47785;:',
                'examples.themes': '&#51452;&#50836; &#53580;&#47560;:',
                'panel.selectedNode': '&#49440;&#53469;&#46108; &#45432;&#46300;',
                'panel.clickNode': '&#45432;&#46300;&#47484; &#53364;&#47533;&#54616;&#47732; &#49345;&#49464;&#51221;&#48372; &#54364;&#49884;',
                'panel.connectedThemes': '&#50672;&#44208;&#46108; &#53580;&#47560;',
                'panel.connectedStocks': '&#50672;&#44208;&#46108; &#51333;&#47785;',
                'panel.searchToSee': '&#51333;&#47785;&#51012; &#44160;&#49353;&#54616;&#47732; &#53580;&#47560; &#54364;&#49884;',
                'panel.backToThemes': '&#8592; &#53580;&#47560; &#47785;&#47197;&#51004;&#47196;',
                'loading': '&#44536;&#47000;&#54532; &#47196;&#46377; &#51473;...',
                'controls.physics': '&#47932;&#47532;: ON',
                'controls.physicsOff': '&#47932;&#47532;: OFF',
                'controls.fit': '&#47582;&#52644;',
                'controls.reset': '&#52488;&#44592;&#54868;',
                'stats.stocks': '&#51333;&#47785;',
                'stats.themes': '&#53580;&#47560;',
                'stats.connections': '&#50672;&#44208;',
                'legend.comovement': '&#44400;&#51665;&#49457; &#44053;&#46020;',
                'legend.veryStrong': '&#47588;&#50864; &#44053;&#54632; (>3.0)',
                'legend.strong': '&#44053;&#54632; (1-3)',
                'legend.moderate': '&#48372;&#53685; (0.5-1)',
                'legend.weak': '&#50557;&#54632; (<0.5)',
                'legend.stockSignal': '&#49884;&#44536;&#45328; &#49828;&#53076;&#50612;',
                'legend.strongBuy': '&#44053;&#54632; (&#8805;70)',
                'legend.buy': '&#50577;&#54840; (50-70)',
                'legend.neutral': '&#51473;&#47549; (30-50)',
                'legend.avoid': '&#50557;&#54632; (<30)',
                'badge.stock': '&#51333;&#47785;',
                'badge.theme': '&#53580;&#47560;',
                'toast.notFound': '&#52286;&#51012; &#49688; &#50630;&#49845;&#45768;&#45796;',
                'toast.suggestions': '&#52628;&#52380;:'
            },
            en: {
                title: '<span class="market-flag">&#127472;&#127479;</span>KRX Sector Rotation',
                subtitle: 'Theme-Stock Network Graph',
                'nav.overview': 'Overview',
                'nav.momentum': 'Momentum',
                'nav.signals': 'Signals',
                'nav.cohesion': 'Cohesion',
                'nav.network': 'Network',
                'nav.chat': '&#128172; AI Chat',
                'search.label': 'Search Stock or Theme <span style="color: #64748b;">(partial match)</span>',
                'search.stock': 'Stock',
                'search.theme': 'Theme',
                'search.placeholder': 'e.g., Samsung, Battery, AI',
                'search.button': 'Search',
                'search.hint': 'Type 2+ chars for suggestions (266 themes)',
                'examples.stocks': 'Popular Stocks:',
                'examples.themes': 'Popular Themes:',
                'panel.selectedNode': 'Selected Node',
                'panel.clickNode': 'Click a node to see details',
                'panel.connectedThemes': 'Connected Themes',
                'panel.connectedStocks': 'Connected Stocks',
                'panel.searchToSee': 'Search for a stock to see themes',
                'panel.backToThemes': '&#8592; Back to Themes',
                'loading': 'Loading graph...',
                'controls.physics': 'Physics: ON',
                'controls.physicsOff': 'Physics: OFF',
                'controls.fit': 'Fit View',
                'controls.reset': 'Reset',
                'stats.stocks': 'Stocks',
                'stats.themes': 'Themes',
                'stats.connections': 'Connections',
                'legend.comovement': 'Co-movement Gravity',
                'legend.veryStrong': 'Very Strong (>3.0)',
                'legend.strong': 'Strong (1-3)',
                'legend.moderate': 'Moderate (0.5-1)',
                'legend.weak': 'Weak (<0.5)',
                'legend.stockSignal': 'Signal Score',
                'legend.strongBuy': 'Strong (&#8805;70)',
                'legend.buy': 'Good (50-70)',
                'legend.neutral': 'Neutral (30-50)',
                'legend.avoid': 'Weak (<30)',
                'badge.stock': 'Stock',
                'badge.theme': 'Theme',
                'toast.notFound': 'Not Found',
                'toast.suggestions': 'Suggestions:'
            }
        };

        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('krx-dashboard-lang', lang);

            // Update toggle buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === (lang === 'ko' ? 'KOR' : 'ENG'));
            });

            // Update all i18n elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const text = t(key);
                if (text) el.innerHTML = text;
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const text = t(key);
                if (text) el.placeholder = text;
            });

            // Update physics button based on current state
            const physicsBtn = document.getElementById('physicsBtn');
            if (physicsBtn) {
                physicsBtn.textContent = physicsEnabled ? t('controls.physics') : t('controls.physicsOff');
            }
        }

        function initLanguage() {
            const saved = localStorage.getItem('krx-dashboard-lang');
            if (saved) {
                currentLang = saved;
            }
            setLanguage(currentLang);
        }

        // Network options
        const options = {
            nodes: {
                font: {
                    color: '#ffffff',
                    size: 12,
                    face: 'system-ui'
                },
                borderWidth: 2,
                shadow: true
            },
            edges: {
                color: {
                    color: '#8b5cf6',
                    opacity: 0.6
                },
                width: 2,
                smooth: {
                    type: 'continuous'
                }
            },
            physics: {
                enabled: true,
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                    gravitationalConstant: -100,
                    centralGravity: 0.01,
                    springLength: 150,
                    springConstant: 0.05,
                    avoidOverlap: 0.5
                },
                stabilization: {
                    iterations: 100,
                    updateInterval: 25
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200
            }
        };

        function initNetwork() {
            const container = document.getElementById('network');
            network = new vis.Network(container, { nodes, edges }, options);

            network.on('click', onNodeClick);
            network.on('doubleClick', onNodeDoubleClick);
            network.on('stabilized', () => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            });

            loadDefaultGraph();
        }

        async function loadDefaultGraph() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/network/graph-data`);
                const data = await response.json();
                renderGraph(data);
            } catch (error) {
                console.error('Error loading graph:', error);
                hideLoading();
            }
        }

        function getStockColor(signal, buyPct) {
            const pct = buyPct || 0;
            if (signal === 'strong_buy' || pct >= 70) {
                return { bg: '#059669', border: '#047857' };
            } else if (signal === 'buy' || pct >= 50) {
                return { bg: '#10b981', border: '#059669' };
            } else if (signal === 'neutral' || pct >= 30) {
                return { bg: '#f59e0b', border: '#d97706' };
            } else {
                return { bg: '#ef4444', border: '#dc2626' };
            }
        }

        function getSignalLabel(signal, buyPct) {
            const pct = buyPct || 0;
            if (signal === 'strong_buy' || pct >= 70) return 'strong_buy';
            if (signal === 'buy' || pct >= 50) return 'buy';
            if (signal === 'neutral' || pct >= 30) return 'hold';
            return 'avoid';
        }

        function getSignalText(signal, score) {
            const s = score || 0;
            if (signal === 'strong_buy' || s >= 70) return `STRONG ${s}`;
            if (signal === 'buy' || s >= 50) return `GOOD ${s}`;
            if (signal === 'neutral' || s >= 30) return `NEUTRAL ${s}`;
            return `WEAK ${s}`;
        }

        function renderGraph(data) {
            nodes.clear();
            edges.clear();
            expandedThemes.clear();

            data.nodes.forEach(node => {
                let visNode;

                if (node.type === 'stock') {
                    const colors = getStockColor(node.signal, node.score);
                    visNode = {
                        id: node.id,
                        label: node.label,
                        title: getNodeTooltip(node),
                        shape: 'dot',
                        color: {
                            background: colors.bg,
                            border: colors.border,
                            highlight: {
                                background: adjustColor(colors.bg, 20),
                                border: colors.bg
                            }
                        },
                        font: {
                            size: node.isCenter ? 14 : 11,
                            color: '#ffffff'
                        },
                        size: node.isCenter ? 35 : 22,
                        nodeData: node
                    };
                } else {
                    visNode = {
                        id: node.id,
                        label: node.label,
                        title: getNodeTooltip(node),
                        shape: 'box',
                        color: {
                            background: node.color,
                            border: adjustColor(node.color, -20),
                            highlight: {
                                background: adjustColor(node.color, 20),
                                border: node.color
                            }
                        },
                        font: {
                            size: 12,
                            color: '#ffffff',
                            bold: true
                        },
                        size: node.size || 25,
                        nodeData: node
                    };
                }
                nodes.add(visNode);
            });

            data.edges.forEach(edge => {
                edges.add({
                    id: edge.id,
                    from: edge.from,
                    to: edge.to
                });
            });

            updateStats(data.stats);
            hideLoading();

            setTimeout(() => network.fit(), 500);
        }

        function getNodeTooltip(node) {
            if (node.type === 'stock') {
                const ucsText = node.signal_score && node.signal_score.ucs != null ? `\n당사추정치(*): ${node.signal_score.ucs}` : '';
                return `${node.label}\nTicker: ${node.ticker}\nSignal: ${node.signal}\nScore: ${node.score}${ucsText}`;
            } else {
                return `${node.label}\nCohesion: ${node.fiedler}`;
            }
        }

        function adjustColor(hex, amount) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
        }

        let searchTimeout = null;
        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];

        function setSearchMode(mode) {
            searchMode = mode;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('searchInput').placeholder =
                mode === 'stock' ? (currentLang === 'ko' ? '예: 삼성, LG, SK' : 'e.g., Samsung, LG, SK') :
                                   (currentLang === 'ko' ? '예: 반도, 2차전, AI' : 'e.g., Battery, AI, Robot');
            hideSuggestions();
        }

        function quickSearch(type, query) {
            searchMode = type;
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.classList.toggle('active',
                    (type === 'stock' && (tab.textContent.includes('종목') || tab.textContent.includes('Stock'))) ||
                    (type === 'theme' && (tab.textContent.includes('테마') || tab.textContent.includes('Theme')))
                );
            });
            document.getElementById('searchInput').value = query;
            hideSuggestions();
            doSearch();
        }

        function onSearchInput() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 2) {
                hideSuggestions();
                return;
            }

            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => fetchSuggestions(query), 200);
        }

        async function fetchSuggestions(query) {
            try {
                const response = await fetch(`${API_BASE}/api/network/search?q=${encodeURIComponent(query)}&limit=15`);
                const data = await response.json();

                if (!data.success) {
                    hideSuggestions();
                    return;
                }

                currentSuggestions = [];
                const container = document.getElementById('searchSuggestions');

                let html = '';

                if (searchMode === 'stock') {
                    data.stocks.forEach(stock => {
                        currentSuggestions.push({ type: 'stock', name: stock.name, data: stock });
                        const buyClass = stock.buy_pct >= 50 ? 'high' : stock.buy_pct >= 30 ? 'medium' : 'low';
                        html += `
                            <div class="suggestion-item" onclick="selectSuggestion('stock', '${stock.name.replace(/'/g, "\\'")}')">
                                <span class="suggestion-name">${stock.name}</span>
                                <span class="suggestion-type stock">${t('badge.stock')}</span>
                                <span class="suggestion-buy-pct ${buyClass}">${stock.buy_pct}</span>
                            </div>
                        `;
                    });
                    data.themes.forEach(theme => {
                        currentSuggestions.push({ type: 'theme', name: theme.theme, data: theme });
                        html += `
                            <div class="suggestion-item" onclick="selectSuggestion('theme', '${theme.theme.replace(/'/g, "\\'")}')">
                                <span class="suggestion-name">${theme.theme}</span>
                                <span class="suggestion-type theme">${t('badge.theme')}</span>
                                <span class="suggestion-fiedler">${theme.fiedler.toFixed(2)}</span>
                            </div>
                        `;
                    });
                } else {
                    data.themes.forEach(theme => {
                        currentSuggestions.push({ type: 'theme', name: theme.theme, data: theme });
                        html += `
                            <div class="suggestion-item" onclick="selectSuggestion('theme', '${theme.theme.replace(/'/g, "\\'")}')">
                                <span class="suggestion-name">${theme.theme}</span>
                                <span class="suggestion-type theme">${t('badge.theme')}</span>
                                <span class="suggestion-fiedler">${theme.fiedler.toFixed(2)}</span>
                            </div>
                        `;
                    });
                    data.stocks.forEach(stock => {
                        currentSuggestions.push({ type: 'stock', name: stock.name, data: stock });
                        const buyClass = stock.buy_pct >= 50 ? 'high' : stock.buy_pct >= 30 ? 'medium' : 'low';
                        html += `
                            <div class="suggestion-item" onclick="selectSuggestion('stock', '${stock.name.replace(/'/g, "\\'")}')">
                                <span class="suggestion-name">${stock.name}</span>
                                <span class="suggestion-type stock">${t('badge.stock')}</span>
                                <span class="suggestion-buy-pct ${buyClass}">${stock.buy_pct}</span>
                            </div>
                        `;
                    });
                }

                if (html) {
                    container.innerHTML = html;
                    container.classList.remove('hidden');
                    selectedSuggestionIndex = -1;
                } else {
                    hideSuggestions();
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                hideSuggestions();
            }
        }

        function onSearchKeydown(event) {
            const container = document.getElementById('searchSuggestions');
            const items = container.querySelectorAll('.suggestion-item');

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
                updateSelectedSuggestion(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSelectedSuggestion(items);
            } else if (event.key === 'Enter') {
                if (selectedSuggestionIndex >= 0 && currentSuggestions[selectedSuggestionIndex]) {
                    const suggestion = currentSuggestions[selectedSuggestionIndex];
                    selectSuggestion(suggestion.type, suggestion.name);
                } else {
                    doSearch();
                }
            } else if (event.key === 'Escape') {
                hideSuggestions();
            }
        }

        function updateSelectedSuggestion(items) {
            items.forEach((item, i) => {
                item.classList.toggle('selected', i === selectedSuggestionIndex);
            });
            if (selectedSuggestionIndex >= 0 && items[selectedSuggestionIndex]) {
                items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function selectSuggestion(type, name) {
            document.getElementById('searchInput').value = name;
            searchMode = type;
            document.querySelectorAll('.tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (type === 'stock' && i === 0) || (type === 'theme' && i === 1));
            });
            hideSuggestions();
            doSearch();
        }

        function hideSuggestions() {
            document.getElementById('searchSuggestions').classList.add('hidden');
            selectedSuggestionIndex = -1;
            currentSuggestions = [];
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                hideSuggestions();
            }
        });

        function showError(message) {
            const existing = document.querySelector('.error-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'error-toast';

            let title = t('toast.notFound');
            let detail = message;
            let suggestions = '';

            if (message.includes('Did you mean:')) {
                const parts = message.split('. Did you mean: ');
                detail = parts[0];
                suggestions = parts[1]?.replace('?', '') || '';
            } else if (message.includes('Available themes:')) {
                const parts = message.split('. Available themes: ');
                detail = parts[0];
                suggestions = parts[1] || '';
            }

            toast.innerHTML = `
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
                <div class="toast-title">${title}</div>
                <div>${detail}</div>
                ${suggestions ? `<div class="toast-suggestions">${t('toast.suggestions')} ${suggestions}</div>` : ''}
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 6000);
        }

        async function doSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            showLoading();
            try {
                const param = searchMode === 'stock' ? `stock=${encodeURIComponent(query)}` : `theme=${encodeURIComponent(query)}`;
                const response = await fetch(`${API_BASE}/api/network/graph-data?${param}&depth=1`);
                const data = await response.json();

                if (!data.success) {
                    showError(data.detail || 'Not found');
                    hideLoading();
                    return;
                }

                renderGraph(data);
                loadConnectionList(query, searchMode);
            } catch (error) {
                console.error('Error:', error);
                showError('Search failed: ' + error.message);
                hideLoading();
            }
        }

        async function loadConnectionList(name, type) {
            try {
                let endpoint, titleText;
                if (type === 'stock') {
                    endpoint = `/api/network/stock-themes?name=${encodeURIComponent(name)}`;
                    titleText = t('panel.connectedThemes');
                } else {
                    endpoint = `/api/network/theme-stocks?theme=${encodeURIComponent(name)}&limit=20`;
                    titleText = t('panel.connectedStocks');
                }

                const response = await fetch(`${API_BASE}${endpoint}`);
                const data = await response.json();

                document.getElementById('connectionTitle').textContent = titleText;
                const list = document.getElementById('connectionList');

                if (type === 'stock' && data.themes) {
                    currentStockThemes = data.themes;
                    refreshThemeList();
                } else if (type === 'theme' && data.stocks) {
                    list.innerHTML = data.stocks.map(s => {
                        const score = s.buy_pct || 0;
                        const scoreColor = score >= 70 ? '#059669' : score >= 50 ? '#10b981' : score >= 30 ? '#f59e0b' : '#ef4444';
                        return `
                        <div class="theme-item" onclick="loadStock('${s.name.replace(/'/g, "\\'")}')">
                            <span class="theme-name">${s.name}</span>
                            <span class="theme-fiedler" style="background:${scoreColor}; color:white;">${score}</span>
                        </div>`;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        async function expandTheme(themeName) {
            if (expandedThemes.has(themeName)) {
                collapseTheme(themeName);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/network/theme-stocks?theme=${encodeURIComponent(themeName)}&limit=15`);
                const data = await response.json();

                if (!data.success) return;

                updateStockList(themeName, data);

                data.stocks.forEach(stock => {
                    const nodeId = `stock_${stock.name}`;
                    if (!nodes.get(nodeId)) {
                        const score = stock.buy_pct || 0;
                        const colors = getStockColor(stock.signal, score);
                        const signalLabel = getSignalLabel(stock.signal, score);

                        nodes.add({
                            id: nodeId,
                            label: stock.name,
                            title: `${stock.name}\nTicker: ${stock.ticker}\nScore: ${score}\nSignal: ${signalLabel}`,
                            shape: 'dot',
                            color: {
                                background: colors.bg,
                                border: colors.border,
                                highlight: {
                                    background: adjustColor(colors.bg, 20),
                                    border: colors.bg
                                }
                            },
                            size: 20,
                            nodeData: { type: 'stock', ...stock, signalLabel, score }
                        });

                        edges.add({
                            id: `edge_${themeName}_${stock.name}`,
                            from: `theme_${themeName}`,
                            to: nodeId
                        });
                    }
                });

                expandedThemes.add(themeName);
                updateStats();
            } catch (error) {
                console.error('Error expanding theme:', error);
            }
        }

        function refreshThemeList() {
            if (!currentStockThemes) return;
            const list = document.getElementById('connectionList');
            list.innerHTML = currentStockThemes.map(t => {
                const isExpanded = expandedThemes.has(t.theme);
                return `
                    <div class="theme-item ${isExpanded ? 'expanded' : ''}" onclick="expandTheme('${t.theme.replace(/'/g, "\\'")}')">
                        <span class="theme-name">${isExpanded ? '\u25BC' : '\u25B6'} ${t.theme}</span>
                        <span class="theme-fiedler ${t.cohesion_level}">${t.fiedler.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
        }

        function updateStockList(themeName, data) {
            document.getElementById('connectionTitle').textContent = `${themeName} ${t('stats.stocks')}`;
            const list = document.getElementById('connectionList');

            const strongCount = data.stocks.filter(s => (s.buy_pct || 0) >= 50).length;
            const weakCount = data.stocks.filter(s => (s.buy_pct || 0) < 30).length;

            let html = `
                <div class="theme-header">
                    <h4>Cohesion: ${data.fiedler.toFixed(2)}</h4>
                    <div class="theme-stats">
                        <span style="color: #10b981;">${strongCount} Strong</span> /
                        <span style="color: #ef4444;">${weakCount} Weak</span>
                    </div>
                </div>
                <div class="stock-list">
            `;

            data.stocks.forEach(stock => {
                const score = stock.buy_pct || 0;
                const signalLabel = getSignalLabel(stock.signal, score);
                const scoreColor = score >= 70 ? '#059669' : score >= 50 ? '#10b981' : score >= 30 ? '#f59e0b' : '#ef4444';
                html += `
                    <div class="stock-item ${signalLabel}">
                        <div class="stock-info" onclick="loadStock('${stock.name.replace(/'/g, "\\'")}')" style="cursor: pointer;">
                            <div class="stock-name">${stock.name}</div>
                            <div class="stock-ticker">${stock.ticker} &middot; ${stock.market}</div>
                        </div>
                        <div class="stock-signal" style="display: flex; align-items: center; gap: 0.375rem;">
                            <span class="signal-badge ${signalLabel}" onclick="window.open('${STOCK_CHART_URL}?name=${encodeURIComponent(stock.name)}', '_blank')" style="cursor: pointer; color: ${scoreColor}; font-weight: bold;" title="Open Chart">${score}</span>
                            ${stock.signal_score && stock.signal_score.ucs != null ? `<span style="color: ${stock.signal_score.ucs >= 70 ? '#059669' : stock.signal_score.ucs >= 50 ? '#f59e0b' : '#ef4444'}; font-size: 0.7rem; opacity: 0.85;" title="당사추정치">(*${stock.signal_score.ucs})</span>` : ''}
                        </div>
                    </div>
                `;
            });

            html += `</div>
                <div class="expand-hint">${currentLang === 'ko' ? '종목을 클릭하면 테마 표시' : 'Click stock to see its themes'}</div>
                <button onclick="backToThemeList()" style="width: 100%; margin-top: 0.75rem; padding: 0.5rem; background: #475569; border: none; border-radius: 0.375rem; color: #e2e8f0; cursor: pointer; font-size: 0.8125rem;">
                    ${t('panel.backToThemes')}
                </button>
            `;

            list.innerHTML = html;
        }

        function backToThemeList() {
            if (currentStockThemes) {
                document.getElementById('connectionTitle').textContent = t('panel.connectedThemes');
                refreshThemeList();
            }
        }

        function collapseTheme(themeName) {
            const edgesToRemove = edges.get().filter(e =>
                e.from === `theme_${themeName}` && e.to.startsWith('stock_')
            );

            edgesToRemove.forEach(edge => {
                const nodeId = edge.to;
                const otherEdges = edges.get().filter(e =>
                    (e.to === nodeId || e.from === nodeId) && e.id !== edge.id
                );

                if (otherEdges.length === 0) {
                    nodes.remove(nodeId);
                }
                edges.remove(edge.id);
            });

            expandedThemes.delete(themeName);
            updateStats();

            if (currentStockThemes) {
                document.getElementById('connectionTitle').textContent = t('panel.connectedThemes');
                refreshThemeList();
            }
        }

        function loadStock(stockName) {
            document.getElementById('searchInput').value = stockName;
            searchMode = 'stock';
            document.querySelectorAll('.tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', i === 0);
            });
            doSearch();
        }

        function onNodeClick(params) {
            if (params.nodes.length === 0) return;

            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            if (!node || !node.nodeData) return;

            const data = node.nodeData;
            const details = document.getElementById('nodeDetails');

            if (data.type === 'stock') {
                const score = data.score || 0;
                const ss = data.signal_score || {};
                const stockName = data.label || data.name;
                const scoreColor = score >= 70 ? '#059669' : score >= 50 ? '#10b981' : score >= 30 ? '#f59e0b' : '#ef4444';
                details.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">${currentLang === 'ko' ? '종목명' : 'Name'}</span>
                        <span class="info-value">${stockName}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">${currentLang === 'ko' ? '티커' : 'Ticker'}</span>
                        <span class="info-value">${data.ticker || '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">${currentLang === 'ko' ? '시그널 스코어' : 'Signal Score'}</span>
                        <span class="info-value" style="color: ${scoreColor}; font-weight: bold; font-size: 1.25rem;">${score}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">${currentLang === 'ko' ? '세부항목' : 'Breakdown'}</span>
                        <span class="info-value" style="font-size: 0.75rem;">
                            Momentum ${ss.momentum || 0} &middot; Trend ${ss.trend || 0} &middot; Vol ${ss.volatility || 0}
                        </span>
                    </div>
                    ${ss.ucs != null ? `
                    <div class="info-item">
                        <span class="info-label">당사추정치 (*)</span>
                        <span class="info-value" style="color: ${ss.ucs >= 70 ? '#059669' : ss.ucs >= 50 ? '#f59e0b' : '#ef4444'}; font-weight: bold; font-size: 1.1rem;">${ss.ucs}</span>
                    </div>` : ''}
                    <button onclick="window.open('${STOCK_CHART_URL}?name=${encodeURIComponent(stockName)}', '_blank')"
                            style="width: 100%; margin-top: 0.75rem; padding: 0.5rem; background: #3b82f6; border: none; border-radius: 0.375rem; color: white; cursor: pointer; font-size: 0.875rem;">
                        &#128200; ${currentLang === 'ko' ? '차트 보기' : 'Open Chart'}
                    </button>
                `;
            } else {
                const level = data.fiedler > 3 ? 'very-strong' :
                              data.fiedler >= 1 ? 'strong' :
                              data.fiedler >= 0.5 ? 'moderate' : 'weak';
                const isExpanded = expandedThemes.has(data.label);
                details.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">${currentLang === 'ko' ? '테마' : 'Theme'}</span>
                        <span class="info-value">${data.label}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">${currentLang === 'ko' ? '군집성' : 'Co-movement'}</span>
                        <span class="info-value ${level}">${data.fiedler?.toFixed(3) || '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">${currentLang === 'ko' ? '상태' : 'Status'}</span>
                        <span class="info-value">${isExpanded ?
                            (currentLang === 'ko' ? '펼침 (클릭하면 접힘)' : 'Expanded (click to collapse)') :
                            (currentLang === 'ko' ? '클릭하면 펼침' : 'Click to expand')}</span>
                    </div>
                `;

                expandTheme(data.label);
            }
        }

        function onNodeDoubleClick(params) {
            if (params.nodes.length === 0) return;

            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            if (!node || !node.nodeData) return;

            const data = node.nodeData;

            if (data.type === 'theme') {
                expandTheme(data.label);
            } else if (data.type === 'stock') {
                loadStock(data.label || data.name);
            }
        }

        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            network.setOptions({ physics: { enabled: physicsEnabled } });
            const btn = document.getElementById('physicsBtn');
            btn.textContent = physicsEnabled ? t('controls.physics') : t('controls.physicsOff');
            btn.classList.toggle('active', physicsEnabled);
        }

        function fitGraph() {
            network.fit({ animation: true });
        }

        function resetGraph() {
            loadDefaultGraph();
        }

        function updateStats(stats) {
            if (stats) {
                document.getElementById('statStocks').textContent = stats.stock_count;
                document.getElementById('statThemes').textContent = stats.theme_count;
                document.getElementById('statEdges').textContent = stats.edge_count;
            } else {
                document.getElementById('statStocks').textContent = nodes.get().filter(n => n.nodeData?.type === 'stock').length;
                document.getElementById('statThemes').textContent = nodes.get().filter(n => n.nodeData?.type === 'theme').length;
                document.getElementById('statEdges').textContent = edges.length;
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Handle Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') doSearch();
        });

        // Initialize
        initLanguage();
        initNetwork();

        // Check URL params
        const urlParams = new URLSearchParams(window.location.search);
        const stockParam = urlParams.get('stock');
        const themeParam = urlParams.get('theme');

        if (stockParam) {
            document.getElementById('searchInput').value = stockParam;
            searchMode = 'stock';
            setTimeout(doSearch, 500);
        } else if (themeParam) {
            document.getElementById('searchInput').value = themeParam;
            searchMode = 'theme';
            setTimeout(doSearch, 500);
        }
    </script>
</body>
</html>

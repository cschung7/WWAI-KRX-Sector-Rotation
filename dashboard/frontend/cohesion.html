<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Theme Cohesion (Íµ∞ÏßëÏÑ±) - Investment Dashboard</title>
    <!-- Version: 2026.01.30.v1 - KOR/ENG language toggle -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 1.5rem 2rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #94a3b8;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .nav-links a {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .nav-links a:hover, .nav-links a.active {
            background: #334155;
            color: #f8fafc;
        }

        .nav-links a.home-btn {
            background: #3b82f6;
            color: #fff;
            font-weight: 500;
        }

        .nav-links a.home-btn:hover {
            background: #2563eb;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: #1e293b;
            border-radius: 0.75rem;
            padding: 1.25rem;
            text-align: center;
        }

        .summary-card.increasing {
            border-left: 4px solid #10b981;
        }

        .summary-card.decreasing {
            border-left: 4px solid #ef4444;
        }

        .summary-card.stable {
            border-left: 4px solid #3b82f6;
        }

        .summary-label {
            color: #94a3b8;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .summary-value.green { color: #10b981; }
        .summary-value.red { color: #ef4444; }
        .summary-value.blue { color: #3b82f6; }

        .section {
            background: #1e293b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: #334155;
            border: none;
            border-radius: 0.5rem;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .tab.active {
            background: #3b82f6;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #475569;
        }

        .chart-container {
            height: 500px;
            position: relative;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.very-strong { background: #10b981; }
        .legend-color.strong { background: #3b82f6; }
        .legend-color.moderate { background: #f59e0b; }
        .legend-color.weak { background: #ef4444; }

        /* Theme Cards with Trend */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .theme-card {
            background: #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            border-left: 4px solid #3b82f6;
            transition: transform 0.2s;
        }

        .theme-card:hover {
            transform: translateX(4px);
        }

        .theme-card.very-strong { border-left-color: #10b981; }
        .theme-card.strong { border-left-color: #3b82f6; }
        .theme-card.moderate { border-left-color: #f59e0b; }
        .theme-card.weak { border-left-color: #ef4444; }

        .theme-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .theme-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .trend-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .trend-indicator.increasing {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .trend-indicator.decreasing {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .trend-indicator.stable {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .trend-arrow {
            font-size: 1rem;
        }

        .theme-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: #f8fafc;
        }

        .stat-value.very-strong, .stat-value.very_strong { color: #10b981; }
        .stat-value.strong { color: #3b82f6; }
        .stat-value.moderate { color: #f59e0b; }
        .stat-value.weak { color: #ef4444; }
        .stat-value.green { color: #10b981; }
        .stat-value.red { color: #ef4444; }

        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
        }

        /* Volatility bar */
        .volatility-bar {
            height: 4px;
            background: #475569;
            border-radius: 2px;
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .volatility-fill {
            height: 100%;
            background: #8b5cf6;
            border-radius: 2px;
        }

        /* Interpretation Guide */
        .guide {
            background: #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .guide h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: #f8fafc;
        }

        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .guide-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .guide-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .guide-badge.very-strong { background: #10b981; color: white; }
        .guide-badge.strong { background: #3b82f6; color: white; }
        .guide-badge.moderate { background: #f59e0b; color: black; }
        .guide-badge.weak { background: #ef4444; color: white; }

        .guide-text {
            font-size: 0.875rem;
            color: #cbd5e1;
        }

        .guide-text strong {
            color: #f8fafc;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        /* Top movers section */
        .movers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .movers-grid {
                grid-template-columns: 1fr;
            }
        }

        .movers-list {
            list-style: none;
        }

        .movers-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #475569;
        }

        .movers-list li:last-child {
            border-bottom: none;
        }

        .mover-theme {
            font-size: 0.875rem;
        }

        .mover-slope {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .mover-slope.positive { color: #10b981; }
        .mover-slope.negative { color: #ef4444; }

        /* Language Toggle */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .header-content { flex: 1; }
        .lang-toggle {
            display: flex;
            gap: 0.25rem;
            background: #334155;
            padding: 0.25rem;
            border-radius: 0.5rem;
            margin-left: 1rem;
        }
        .lang-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            background: transparent;
            color: #94a3b8;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
        .lang-btn:hover { color: #f8fafc; }
        .lang-btn.active { background: #3b82f6; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container" style="padding: 0;">
            <div class="header-top">
                <div class="header-content">
                    <h1 data-i18n="title">Theme Cohesion Analysis (Íµ∞ÏßëÏÑ±)</h1>
                    <p data-i18n="subtitle">Gravity - How synchronized are stocks within each theme?</p>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                    <div id="lastUpdate" style="font-size: 0.75rem; color: #94a3b8;"></div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <select id="dateSelector" onchange="loadHistoricalData(this.value)" style="
                            background: #334155;
                            color: #f8fafc;
                            border: 1px solid #475569;
                            border-radius: 0.375rem;
                            padding: 0.375rem 0.75rem;
                            font-size: 0.75rem;
                            cursor: pointer;
                        ">
                            <option value="">Loading dates...</option>
                        </select>
                        <div class="lang-toggle">
                            <button class="lang-btn active" onclick="setLanguage('ko')">KOR</button>
                            <button class="lang-btn" onclick="setLanguage('en')">ENG</button>
                        </div>
                    </div>
                </div>
            </div>
            <nav class="nav-links">
                <a href="https://landing-three-ecru.vercel.app" class="home-btn">üè† Home</a>
                <a href="index.html" data-i18n="nav.overview">Overview</a>
                <a href="breakout.html" data-i18n="nav.breakout">Breakout</a>
                <a href="signals.html" data-i18n="nav.signals">Signals</a>
                <a href="cohesion.html" class="active" data-i18n="nav.comovement">Co-movement</a>
                <a href="theme-graph.html" data-i18n="nav.network">Network</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <!-- Summary Cards -->
        <div class="summary-grid" id="summaryGrid">
            <div class="loading" data-i18n="loading">Loading trends...</div>
        </div>

        <!-- Top Movers -->
        <div class="movers-grid">
            <div class="section">
                <h2 data-i18n="section.topIncreasing">Top 5 Increasing Co-movement</h2>
                <ul class="movers-list" id="increasingList">
                    <li class="loading" data-i18n="loading">Loading...</li>
                </ul>
            </div>
            <div class="section">
                <h2 data-i18n="section.topDecreasing">Top 5 Decreasing Co-movement</h2>
                <ul class="movers-list" id="decreasingList">
                    <li class="loading" data-i18n="loading">Loading...</li>
                </ul>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color very-strong"></div>
                <span data-i18n="legend.veryStrong">Very Strong (> 3.0)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color strong"></div>
                <span data-i18n="legend.strong">Strong (1.0 - 3.0)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color moderate"></div>
                <span data-i18n="legend.moderate">Moderate (0.5 - 1.0)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color weak"></div>
                <span data-i18n="legend.weak">Weak (< 0.5)</span>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="section">
            <h2 data-i18n="section.chartTitle">Gravity by Theme</h2>
            <div class="tabs">
                <button class="tab active" onclick="setView('all')" data-i18n="tab.allThemes">All Themes</button>
                <button class="tab" onclick="setView('increasing')" data-i18n="tab.increasing">Increasing</button>
                <button class="tab" onclick="setView('decreasing')" data-i18n="tab.decreasing">Decreasing</button>
                <button class="tab" onclick="setView('top20')" data-i18n="tab.top20">Top 20</button>
            </div>
            <div class="chart-container">
                <canvas id="cohesionChart"></canvas>
            </div>
        </div>

        <!-- Theme Cards with Trends -->
        <div class="section">
            <h2 data-i18n="section.themeDetails">Theme Details with Trend Analysis</h2>
            <div class="tabs">
                <button class="tab active" onclick="filterCards('all')" data-i18n="tab.all">All</button>
                <button class="tab" onclick="filterCards('increasing')" data-i18n="tab.increasingOnly">Increasing Only</button>
                <button class="tab" onclick="filterCards('decreasing')" data-i18n="tab.decreasingOnly">Decreasing Only</button>
                <button class="tab" onclick="filterCards('very_strong')" data-i18n="tab.veryStrong">Very Strong</button>
            </div>
            <div class="theme-grid" id="themeGrid">
                <div class="loading" data-i18n="loading.themes">Loading themes...</div>
            </div>
        </div>

        <!-- Interpretation Guide -->
        <div class="section">
            <div class="guide">
                <h3 data-i18n="guide.title">Interpretation Guide</h3>
                <div class="guide-grid">
                    <div class="guide-item">
                        <span class="guide-badge very-strong">> 3.0</span>
                        <div class="guide-text" data-i18n="guide.veryStrong">
                            <strong>Very Strong (Í∞ïÌïú Íµ∞ÏßëÏÑ±)</strong><br>
                            Stocks move together. Lower idiosyncratic risk. Best for sector rotation.
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="guide-badge strong">1.0 - 3.0</span>
                        <div class="guide-text" data-i18n="guide.strong">
                            <strong>Strong (ÏñëÌò∏Ìïú Íµ∞ÏßëÏÑ±)</strong><br>
                            Good theme correlation. Sector plays effective.
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="guide-badge moderate">0.5 - 1.0</span>
                        <div class="guide-text" data-i18n="guide.moderate">
                            <strong>Moderate (Î≥¥ÌÜµ Íµ∞ÏßëÏÑ±)</strong><br>
                            Some fragmentation. Stock selection matters more.
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="guide-badge weak">< 0.5</span>
                        <div class="guide-text" data-i18n="guide.weak">
                            <strong>Weak (ÏïΩÌïú Íµ∞ÏßëÏÑ±)</strong><br>
                            Fragmented theme. Higher idiosyncratic risk. Avoid for rotation.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let cohesionChart = null;
        let allTrends = [];
        let allThemes = [];  // From themes API with fiedler_change
        let currentView = 'all';
        let currentFilter = 'all';
        let currentLang = 'ko';

        const translations = {
            ko: {
                title: 'ÌÖåÎßà Íµ∞ÏßëÏÑ± Î∂ÑÏÑù',
                subtitle: 'Íµ∞ÏßëÏÑ± Í∞ïÎèÑ - ÌÖåÎßà ÎÇ¥ Ï¢ÖÎ™©Îì§Ïù¥ ÏñºÎßàÎÇò ÎèôÏ°∞ÌôîÎêòÏñ¥ ÏûàÎäîÍ∞Ä?',
                'nav.overview': 'Í∞úÏöî',
                'nav.breakout': 'Î™®Î©òÌÖÄ',
                'nav.signals': 'ÏãúÍ∑∏ÎÑê',
                'nav.comovement': 'Íµ∞ÏßëÏÑ±',
                'nav.network': 'ÎÑ§Ìä∏ÏõåÌÅ¨',
                'loading': 'Î°úÎî© Ï§ë...',
                'loading.themes': 'ÌÖåÎßà Î°úÎî© Ï§ë...',
                'section.topIncreasing': 'Íµ∞ÏßëÏÑ± ÏÉÅÏäπ TOP 5',
                'section.topDecreasing': 'Íµ∞ÏßëÏÑ± ÌïòÎùΩ TOP 5',
                'section.chartTitle': 'ÌÖåÎßàÎ≥Ñ Íµ∞ÏßëÏÑ± Í∞ïÎèÑ',
                'section.themeDetails': 'ÌÖåÎßà ÏÉÅÏÑ∏ Î∞è Ï∂îÏÑ∏ Î∂ÑÏÑù',
                'legend.veryStrong': 'Îß§Ïö∞ Í∞ïÌï® (> 3.0)',
                'legend.strong': 'Í∞ïÌï® (1.0 - 3.0)',
                'legend.moderate': 'Î≥¥ÌÜµ (0.5 - 1.0)',
                'legend.weak': 'ÏïΩÌï® (< 0.5)',
                'tab.allThemes': 'Ï†ÑÏ≤¥ ÌÖåÎßà',
                'tab.increasing': 'ÏÉÅÏäπ',
                'tab.decreasing': 'ÌïòÎùΩ',
                'tab.top20': 'TOP 20',
                'tab.all': 'Ï†ÑÏ≤¥',
                'tab.increasingOnly': 'ÏÉÅÏäπÎßå',
                'tab.decreasingOnly': 'ÌïòÎùΩÎßå',
                'tab.veryStrong': 'Îß§Ïö∞ Í∞ïÌï®',
                'guide.title': 'Ìï¥ÏÑù Í∞ÄÏù¥Îìú',
                'guide.veryStrong': '<strong>Îß§Ïö∞ Í∞ïÌï® (Í∞ïÌïú Íµ∞ÏßëÏÑ±)</strong><br>Ï¢ÖÎ™©Îì§Ïù¥ Ìï®Íªò ÏõÄÏßÅÏûÑ. Í∞úÎ≥Ñ ÏúÑÌóò ÎÇÆÏùå. ÏÑπÌÑ∞ Î°úÌÖåÏù¥ÏÖòÏóê Ï†ÅÌï©.',
                'guide.strong': '<strong>Í∞ïÌï® (ÏñëÌò∏Ìïú Íµ∞ÏßëÏÑ±)</strong><br>ÌÖåÎßà ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ ÏñëÌò∏. ÏÑπÌÑ∞ ÌîåÎ†àÏù¥ Ìö®Í≥ºÏ†Å.',
                'guide.moderate': '<strong>Î≥¥ÌÜµ (Î≥¥ÌÜµ Íµ∞ÏßëÏÑ±)</strong><br>ÏùºÎ∂Ä Î∂ÑÏÇ∞Îê®. Ï¢ÖÎ™© ÏÑ†Ï†ïÏù¥ Îçî Ï§ëÏöî.',
                'guide.weak': '<strong>ÏïΩÌï® (ÏïΩÌïú Íµ∞ÏßëÏÑ±)</strong><br>ÌÖåÎßà Î∂ÑÏÇ∞Îê®. Í∞úÎ≥Ñ ÏúÑÌóò ÎÜíÏùå. Î°úÌÖåÏù¥ÏÖò ÌöåÌîº Í∂åÏû•.',
                'summary.totalThemes': 'Ï†ÑÏ≤¥ ÌÖåÎßà',
                'summary.veryStrong': 'Îß§Ïö∞ Í∞ïÌï®',
                'summary.increasing': 'ÏÉÅÏäπ Ï§ë',
                'summary.decreasing': 'ÌïòÎùΩ Ï§ë',
                'summary.stable': 'ÏïàÏ†ï'
            },
            en: {
                title: 'Theme Cohesion Analysis',
                subtitle: 'Gravity - How synchronized are stocks within each theme?',
                'nav.overview': 'Overview',
                'nav.breakout': 'Breakout',
                'nav.signals': 'Signals',
                'nav.comovement': 'Co-movement',
                'nav.network': 'Network',
                'loading': 'Loading...',
                'loading.themes': 'Loading themes...',
                'section.topIncreasing': 'Top 5 Increasing Co-movement',
                'section.topDecreasing': 'Top 5 Decreasing Co-movement',
                'section.chartTitle': 'Gravity by Theme',
                'section.themeDetails': 'Theme Details with Trend Analysis',
                'legend.veryStrong': 'Very Strong (> 3.0)',
                'legend.strong': 'Strong (1.0 - 3.0)',
                'legend.moderate': 'Moderate (0.5 - 1.0)',
                'legend.weak': 'Weak (< 0.5)',
                'tab.allThemes': 'All Themes',
                'tab.increasing': 'Increasing',
                'tab.decreasing': 'Decreasing',
                'tab.top20': 'Top 20',
                'tab.all': 'All',
                'tab.increasingOnly': 'Increasing Only',
                'tab.decreasingOnly': 'Decreasing Only',
                'tab.veryStrong': 'Very Strong',
                'guide.title': 'Interpretation Guide',
                'guide.veryStrong': '<strong>Very Strong</strong><br>Stocks move together. Lower idiosyncratic risk. Best for sector rotation.',
                'guide.strong': '<strong>Strong</strong><br>Good theme correlation. Sector plays effective.',
                'guide.moderate': '<strong>Moderate</strong><br>Some fragmentation. Stock selection matters more.',
                'guide.weak': '<strong>Weak</strong><br>Fragmented theme. Higher idiosyncratic risk. Avoid for rotation.',
                'summary.totalThemes': 'Total Themes',
                'summary.veryStrong': 'Very Strong',
                'summary.increasing': 'Increasing',
                'summary.decreasing': 'Decreasing',
                'summary.stable': 'Stable'
            }
        };

        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('krx-dashboard-lang', lang);
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === (lang === 'ko' ? 'KOR' : 'ENG'));
            });
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const text = t(key);
                if (text) el.innerHTML = text;
            });
            // Update last update label
            const lastUpdateEl = document.getElementById('lastUpdate');
            if (lastUpdateEl && lastUpdateEl.textContent) {
                const dateMatch = lastUpdateEl.textContent.match(/\d{4}-\d{2}-\d{2}/);
                if (dateMatch) {
                    const label = lang === 'ko' ? 'ÏµúÏ¢ÖÏóÖÎç∞Ïù¥Ìä∏' : 'Last Update';
                    lastUpdateEl.textContent = `${label}: ${dateMatch[0]}`;
                }
            }
        }

        function initLanguage() {
            const saved = localStorage.getItem('krx-dashboard-lang');
            if (saved) currentLang = saved;
            setLanguage(currentLang);
        }

        async function init() {
            try {
                // Fetch both APIs in parallel
                const [trendsResponse, themesResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/sector-rotation/fiedler-trends?weeks=8`),
                    fetch(`${API_BASE}/api/sector-rotation/themes`)
                ]);

                const trendsData = await trendsResponse.json();
                const themesData = await themesResponse.json();

                allTrends = trendsData.trends;
                allThemes = themesData.themes || [];

                // Merge fiedler_change into trends data
                const themeChangeMap = {};
                allThemes.forEach(t => {
                    themeChangeMap[t.theme] = {
                        fiedler_change: t.fiedler_change || 0,
                        pct_change: t.pct_change || 0
                    };
                });
                allTrends.forEach(t => {
                    if (themeChangeMap[t.theme]) {
                        t.fiedler_change = themeChangeMap[t.theme].fiedler_change;
                        t.pct_change = themeChangeMap[t.theme].pct_change;
                    }
                });

                updateSummary(trendsData.summary, allThemes);
                updateMovers(allThemes);  // Use themes data for fiedler_change
                renderChart(allTrends, 'all');
                renderThemeCards(allTrends);
            } catch (error) {
                console.error('Error loading trends:', error);
                document.getElementById('summaryGrid').innerHTML =
                    `<div class="loading">Error: ${error.message}</div>`;
            }
        }

        function updateSummary(summary, themes) {
            // Calculate increasing/decreasing from fiedler_change
            const increasing = themes.filter(t => (t.fiedler_change || 0) > 0.1).length;
            const decreasing = themes.filter(t => (t.fiedler_change || 0) < -0.1).length;
            const stable = themes.length - increasing - decreasing;

            document.getElementById('summaryGrid').innerHTML = `
                <div class="summary-card">
                    <div class="summary-label" data-i18n="summary.totalThemes">${t('summary.totalThemes')}</div>
                    <div class="summary-value">${themes.length || summary.total_themes}</div>
                </div>
                <div class="summary-card increasing">
                    <div class="summary-label" data-i18n="summary.increasing">${t('summary.increasing')}</div>
                    <div class="summary-value green">${increasing}</div>
                </div>
                <div class="summary-card decreasing">
                    <div class="summary-label" data-i18n="summary.decreasing">${t('summary.decreasing')}</div>
                    <div class="summary-value red">${decreasing}</div>
                </div>
                <div class="summary-card stable">
                    <div class="summary-label" data-i18n="summary.stable">${t('summary.stable')}</div>
                    <div class="summary-value blue">${stable}</div>
                </div>
            `;
        }

        function updateMovers(themes) {
            // Sort by fiedler_change (delta) from themes API
            const sorted = [...themes].sort((a, b) => (b.fiedler_change || 0) - (a.fiedler_change || 0));
            const increasing = sorted.slice(0, 5);  // Top 5
            const decreasing = sorted.filter(t => (t.fiedler_change || 0) < 0);

            document.getElementById('increasingList').innerHTML = increasing.map(t => `
                <li>
                    <span class="mover-theme">${t.theme}</span>
                    <span class="mover-slope positive">+${(t.fiedler_change || 0).toFixed(2)} (${(t.pct_change || 0) > 0 ? '+' : ''}${(t.pct_change || 0).toFixed(0)}%)</span>
                </li>
            `).join('');

            // Show "No data" if no declining themes exist
            if (decreasing.length === 0) {
                const noDataMsg = currentLang === 'ko' ? 'Ìï¥Îãπ ÏÇ¨Ìï≠ ÏóÜÏùå' : 'No data';
                document.getElementById('decreasingList').innerHTML = `
                    <li style="color: #94a3b8; font-style: italic; justify-content: center;">
                        ${noDataMsg}
                    </li>
                `;
            } else {
                document.getElementById('decreasingList').innerHTML = decreasing.slice(0, 5).map(t => {
                    const change = t.fiedler_change || 0;
                    const pct = t.pct_change || 0;
                    return `
                        <li>
                            <span class="mover-theme">${t.theme}</span>
                            <span class="mover-slope negative">${change.toFixed(2)} (${pct.toFixed(0)}%)</span>
                        </li>
                    `;
                }).join('');
            }
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.section:nth-child(4) .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderChart(allTrends, view);
        }

        function filterCards(filter) {
            currentFilter = filter;
            document.querySelectorAll('.section:nth-child(5) .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderThemeCards(allTrends);
        }

        function getCohesionColor(level) {
            switch(level) {
                case 'very_strong': return '#10b981';
                case 'strong': return '#3b82f6';
                case 'moderate': return '#f59e0b';
                default: return '#ef4444';
            }
        }

        function renderChart(trends, view) {
            let filtered = [...trends];

            switch(view) {
                case 'increasing':
                    filtered = trends.filter(t => (t.fiedler_change || 0) > 0.1);
                    filtered.sort((a, b) => (b.fiedler_change || 0) - (a.fiedler_change || 0));
                    break;
                case 'decreasing':
                    filtered = trends.filter(t => (t.fiedler_change || 0) < -0.1);
                    filtered.sort((a, b) => (a.fiedler_change || 0) - (b.fiedler_change || 0));
                    break;
                case 'top20':
                    filtered.sort((a, b) => (b.fiedler_change || 0) - (a.fiedler_change || 0));
                    filtered = filtered.slice(0, 20);
                    break;
                default:
                    // Sort by Fiedler value for 'all' view
                    filtered.sort((a, b) => b.latest_fiedler - a.latest_fiedler);
            }

            // Limit to 30 for readability
            if (filtered.length > 30) {
                filtered = filtered.slice(0, 30);
            }

            const ctx = document.getElementById('cohesionChart').getContext('2d');

            if (cohesionChart) {
                cohesionChart.destroy();
            }

            cohesionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filtered.map(t => t.theme),
                    datasets: [{
                        label: 'Gravity',
                        data: filtered.map(t => t.latest_fiedler),
                        backgroundColor: filtered.map(t => getCohesionColor(t.cohesion_level)),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            borderColor: '#475569',
                            borderWidth: 1,
                            titleColor: '#f8fafc',
                            bodyColor: '#cbd5e1',
                            callbacks: {
                                afterLabel: function(context) {
                                    const t = filtered[context.dataIndex];
                                    const change = t.fiedler_change || 0;
                                    const pct = t.pct_change || 0;
                                    const arrow = change > 0 ? '‚Üë' : change < 0 ? '‚Üì' : '‚Üí';
                                    return `Delta: ${arrow} ${change > 0 ? '+' : ''}${change.toFixed(2)} (${pct > 0 ? '+' : ''}${pct.toFixed(0)}%) | Stocks: ${t.n_stocks}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' },
                            title: {
                                display: true,
                                text: 'Gravity',
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            ticks: { color: '#f8fafc', font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderThemeCards(trends) {
            let filtered = [...trends];

            switch(currentFilter) {
                case 'increasing':
                    filtered = trends.filter(t => (t.fiedler_change || 0) > 0.1);
                    break;
                case 'decreasing':
                    filtered = trends.filter(t => (t.fiedler_change || 0) < -0.1);
                    break;
                case 'very_strong':
                    filtered = trends.filter(t => t.cohesion_level === 'very_strong');
                    break;
            }

            // Sort by fiedler_change (delta) for investment signal
            filtered.sort((a, b) => (b.fiedler_change || 0) - (a.fiedler_change || 0));

            const grid = document.getElementById('themeGrid');
            grid.innerHTML = filtered.slice(0, 50).map(t => {
                const change = t.fiedler_change || 0;
                const pctChange = t.pct_change || 0;
                const trendArrow = change > 0.1 ? '‚Üë' : change < -0.1 ? '‚Üì' : '‚Üí';
                const trendClass = change > 0.1 ? 'increasing' : change < -0.1 ? 'decreasing' : 'stable';
                const changeColor = change > 0 ? 'green' : change < 0 ? 'red' : '';

                return `
                    <div class="theme-card ${t.cohesion_level}">
                        <div class="theme-header">
                            <div class="theme-name">${t.theme}</div>
                            <div class="trend-indicator ${trendClass}">
                                <span class="trend-arrow">${trendArrow}</span>
                                <span>${change > 0 ? '+' : ''}${change.toFixed(2)} (${pctChange > 0 ? '+' : ''}${pctChange.toFixed(0)}%)</span>
                            </div>
                        </div>
                        <div class="theme-stats">
                            <div class="stat-item">
                                <div class="stat-value ${t.cohesion_level}">${t.latest_fiedler.toFixed(2)}</div>
                                <div class="stat-label">Level</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value ${changeColor}">${change > 0 ? '+' : ''}${change.toFixed(2)}</div>
                                <div class="stat-label">Delta</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${t.n_stocks}</div>
                                <div class="stat-label">Stocks</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function fetchLastUpdate() {
            try {
                const response = await fetch(`${API_BASE}/api/sector-rotation/themes`);
                const data = await response.json();
                const dateStr = data.date || '';
                if (dateStr && dateStr.length === 8) {
                    const formatted = `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
                    const label = currentLang === 'ko' ? 'ÏµúÏ¢ÖÏóÖÎç∞Ïù¥Ìä∏' : 'Last Update';
                    document.getElementById('lastUpdate').textContent = `${label}: ${formatted}`;
                }
            } catch (e) {
                console.error('Failed to fetch last update:', e);
            }
        }

        async function loadAvailableDates() {
            try {
                const response = await fetch(`${API_BASE}/api/sector-rotation/cohesion-dates`);
                const data = await response.json();
                const selector = document.getElementById('dateSelector');

                // Add "Latest" option first
                const latestLabel = currentLang === 'ko' ? 'ÏµúÏã† Îç∞Ïù¥ÌÑ∞' : 'Latest Data';
                let options = `<option value="">${latestLabel}</option>`;

                // Add historical dates (last 20)
                const dates = data.dates.slice(0, 20);
                dates.forEach(date => {
                    options += `<option value="${date}">${date}</option>`;
                });

                selector.innerHTML = options;
            } catch (e) {
                console.error('Failed to load dates:', e);
                document.getElementById('dateSelector').innerHTML = '<option value="">Error loading dates</option>';
            }
        }

        async function loadHistoricalData(date) {
            if (!date) {
                // Load latest data
                init();
                return;
            }

            try {
                document.getElementById('summaryGrid').innerHTML = '<div class="loading">Loading...</div>';
                document.getElementById('themeGrid').innerHTML = '<div class="loading">Loading...</div>';

                const response = await fetch(`${API_BASE}/api/sector-rotation/cohesion-history?date=${date}`);
                const data = await response.json();

                // Update summary
                const summary = data.summary;
                document.getElementById('summaryGrid').innerHTML = `
                    <div class="summary-card">
                        <div class="summary-label">${t('summary.totalThemes')}</div>
                        <div class="summary-value">${data.count}</div>
                    </div>
                    <div class="summary-card" style="border-left: 4px solid #10b981;">
                        <div class="summary-label">${t('legend.veryStrong')}</div>
                        <div class="summary-value green">${summary.very_strong}</div>
                    </div>
                    <div class="summary-card" style="border-left: 4px solid #3b82f6;">
                        <div class="summary-label">${t('legend.strong')}</div>
                        <div class="summary-value blue">${summary.strong}</div>
                    </div>
                    <div class="summary-card" style="border-left: 4px solid #f59e0b;">
                        <div class="summary-label">${t('legend.moderate')}</div>
                        <div class="summary-value" style="color: #f59e0b;">${summary.moderate}</div>
                    </div>
                `;

                // Convert to trend format for rendering
                const historicalTrends = data.themes.map(t => ({
                    theme: t.theme,
                    latest_fiedler: t.fiedler,
                    cohesion_level: t.cohesion_level,
                    n_stocks: t.n_stocks,
                    fiedler_change: 0,  // No delta for historical
                    pct_change: 0
                }));

                allTrends = historicalTrends;

                // Update movers (top/bottom by Fiedler value)
                const sorted = [...historicalTrends].sort((a, b) => b.latest_fiedler - a.latest_fiedler);
                document.getElementById('increasingList').innerHTML = sorted.slice(0, 5).map(t => `
                    <li>
                        <span class="mover-theme">${t.theme}</span>
                        <span class="mover-slope positive">${t.latest_fiedler.toFixed(2)}</span>
                    </li>
                `).join('');
                document.getElementById('decreasingList').innerHTML = sorted.slice(-5).reverse().map(t => `
                    <li>
                        <span class="mover-theme">${t.theme}</span>
                        <span class="mover-slope negative">${t.latest_fiedler.toFixed(2)}</span>
                    </li>
                `).join('');

                // Update section headers for historical view
                const incHeader = document.querySelector('.movers-grid .section:first-child h2');
                const decHeader = document.querySelector('.movers-grid .section:last-child h2');
                if (incHeader) incHeader.textContent = currentLang === 'ko' ? 'Íµ∞ÏßëÏÑ± TOP 5' : 'Top 5 Cohesion';
                if (decHeader) decHeader.textContent = currentLang === 'ko' ? 'Íµ∞ÏßëÏÑ± ÌïòÏúÑ 5' : 'Bottom 5 Cohesion';

                // Render chart and cards
                renderChart(historicalTrends, 'all');
                renderThemeCards(historicalTrends);

                // Update last update display
                const label = currentLang === 'ko' ? 'Ï°∞Ìöå ÎÇ†Ïßú' : 'Viewing Date';
                document.getElementById('lastUpdate').textContent = `${label}: ${date}`;

            } catch (e) {
                console.error('Failed to load historical data:', e);
                document.getElementById('summaryGrid').innerHTML = `<div class="loading">Error: ${e.message}</div>`;
            }
        }

        // Initialize
        initLanguage();
        init();
        fetchLastUpdate();
        loadAvailableDates();
    </script>

    <!-- Chat Widget -->
    <script src="chat-widget.js"></script>
</body>
</html>
